{% extends 'base.html' %}
{% block content %}
    <h2>Your Calendar</h2>

    <div class="calendar-container">
        <div id="calendar" class="calendar"></div>
        <div id="status" class="status">
            <h3>Status</h3>
            <div id="status-content" class="status-content">
                <p>Select an event to see details.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var statusContent = document.getElementById('status-content');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek',  // List view for mobile, week view for larger screens
                slotDuration: '00:30:00',     // Time blocks of 30 minutes
                nowIndicator: true,           // Show current time indicator
                editable: false,              // No dragging or resizing appointments
                selectable: false,            // No selecting time ranges

                events: [
                    {% for appointment in appointments %}
                    {
                        id: '{{ appointment.id }}',
                        title: 'Appointment with {{ appointment.requester.username }}',
                        start: '{{ appointment.date|date:"Y-m-d\\TH:i:s" }}',  // Start date in proper ISO format
                        end: '{{ appointment.end_time|date:"Y-m-d\\TH:i:s" }}', // End date in proper ISO format
                        description: '{{ appointment.reason }}',
                        extendedProps: {
                            requester: '{{ appointment.requester.username }}',
                            status: '{{ appointment.status }}',
                            reason: '{{ appointment.reason }}',
                            duration: '{{ appointment.end_time|date:"H:i" }}'  // Time duration
                        },
                        color: '{% if appointment.status == "rejected" %}red{% elif appointment.status == "pending" %}orange{% else %}blue{% endif %}'  // Red for cancelled, orange for pending, blue for accepted
                    },
                    {% endfor %}
                ],

                // Event click to show details or redirect for pending requests
                eventClick: function(info) {
                    if (info.event.extendedProps.status === 'pending') {
                        window.location.href = "{% url 'notifications' %}";
                    } else {
                        var duration = (new Date(info.event.end) - new Date(info.event.start)) / 60000;  // Calculate duration in minutes
                        var statusText = '';
                        if (info.event.extendedProps.status === 'rejected') {
                            statusText = 'Cancelled';
                        } else if (new Date(info.event.end) < new Date()) {
                            statusText = 'Completed Appointment';
                        } else {
                            statusText = 'Upcoming Appointment';
                        }
                        var content = `
                            <strong>With:</strong> ${info.event.extendedProps.requester} <br>
                            <strong>Date:</strong> ${info.event.start.toLocaleString()} <br>
                            <strong>Duration:</strong> ${duration} minutes <br>
                            <strong>Reason:</strong> ${info.event.extendedProps.reason} <br>
                            <strong>Status:</strong> ${statusText} <br>
                            <button onclick="deleteEvent(${info.event.id})">Delete</button>
                        `;
                        statusContent.innerHTML = content;
                    }
                },
            });

            calendar.render();
        });

        function deleteEvent(eventId) {
            if (confirm("Are you sure you want to delete this event?")) {
                fetch(`/delete_event/${eventId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Failed to delete the event.");
                    }
                });
            }
        }
    </script>

    <style>
        .calendar-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .calendar {
            flex: 2;
        }
        .status {
            flex: 1;
            padding: 20px;
            border-left: 1px solid #ddd;
        }
        .status-content {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        @media (max-width: 768px) {
            .calendar-container {
                flex-direction: column;
            }
            .status {
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }
    </style>
{% endblock %}
